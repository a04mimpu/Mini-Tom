<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ärende / Uppgift · Ny post (Demo)</title>
<style>
  :root{
    --bg:#0b1733; --panel:#0f1c3a; --line:#19305d; --ink:#e9f3ff; --muted:#9fb6d8;
    --chip:#0a2746; --accent:#00e6ff; --accentText:#062b33;
  }
  html,body{margin:0;background:var(--bg);font-family:Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
  .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 12px}
  .card{background:#0f1c3a;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.3)}
  .head{padding:14px 18px;border-bottom:1px solid var(--line);font-weight:600}
  .body{padding:18px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  label{font-size:13px;color:#9edbff;margin:8px 0 6px;display:block}
  input,select,textarea{
    width:100%;box-sizing:border-box;background:#0b1733;color:var(--ink);
    border:1px solid #2a457a;border-radius:10px;padding:10px 12px
  }
  textarea{min-height:110px;resize:vertical}
  .chips{background:#071c34;border:1px dashed #1f3e6c;border-radius:12px;padding:10px 12px;margin-bottom:18px;display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid #1f3e6c;padding:6px 10px;border-radius:999px;font-size:13px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .foot{padding:14px 18px;border-top:1px solid var(--line);display:flex;gap:12px;justify-content:flex-end;background:#0b1733;border-radius:0 0 14px 14px;flex-wrap:wrap}
  .btn{border:0;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--accent);color:var(--accentText)}
  .btn.ghost{background:#22345e;color:#dff3ff;border:1px solid #34538f}
  .note{color:var(--muted);font-size:12px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Ärende / Uppgift · Ny post</h1>
  <div class="card">
    <div class="head">Formulär (fält förifylls från <b>Beskrivning</b>)</div>
    <div class="body">
      <div id="chips" class="chips" aria-live="polite">
        <span class="chip">Tolkat:</span>
      </div>

      <div class="row">
        <div>
          <label for="anvandare">Användare *</label>
          <input id="anvandare" placeholder="Användare">
        </div>
        <div>
          <label for="adress">Adress *</label>
          <input id="adress" placeholder="Adress">
        </div>
      </div>

      <div class="row">
        <div>
          <label for="konfig">Hårdvara / Artikel *</label>
          <input id="konfig" placeholder="Hårdvara / Artikel">
        </div>
        <div>
          <label for="ansvarskod">Ansvarskod</label>
          <input id="ansvarskod" placeholder="Ansvarskod">
        </div>
      </div>

      <div class="row">
        <div>
          <label for="rubrik">Rubrik *</label>
          <input id="rubrik" placeholder="Rubrik">
        </div>
        <div>
          <label for="kontaktmetod">Kontaktmetod</label>
          <select id="kontaktmetod">
            <option>Telefon</option><option>E-post</option><option>Portal</option>
          </select>
        </div>
      </div>

      <label for="beskrivning" style="margin-top:14px">BESKRIVNING (KÄLLA)</label>
      <textarea id="beskrivning" placeholder="iPhone 15, Gatan 2, mottagande chef Anna Larsson, ansvarskod 12345"></textarea>
      <div class="note">Tips: skriv valfri fritext – knappen <b>AI-tolka (Azure)</b> skickar texten till GPT-4o-mini och fyller fälten.</div>
    </div>

    <div class="foot">
      <button class="btn ghost" id="resetBtn">Återställ</button>
      <button class="btn ghost" id="ruleBtn">Tolka & förifyll (regler)</button>
      <button class="btn primary" id="aiBtn">AI-tolka (Azure)</button>
      <button class="btn primary" id="cartBtn">Till varukorg</button>
    </div>
  </div>
</div>

<script>
/* ===========================
   0) Konfiguration (BYT!)
=========================== */
const AZURE_ENDPOINT   = "https://aoai-demo-mimmi.openai.azure.com/"; // din endpoint (med / på slutet)
const AZURE_API_KEY    = "2DIBaP3ix8V0ZdubOwG81cs5hZqUsl9HKZBHD9A7W9EImov0zyFhJQQJ99BHACfhMk5XJ3w3AAABACOGSSU5";                       // lägg inte i publik kod i skarpt läge
const AZURE_DEPLOYMENT = "gpt-4o-mini";                                // ditt deploymentnamn
const AZURE_API_VER    = "2024-02-15-preview";

/* ===========================
   Hjälpare
=========================== */
const $ = (id)=>document.getElementById(id);
function addChip(text){
  const s = document.createElement('span');
  s.className='chip'; s.textContent=text; $('chips').appendChild(s);
}
function clearChips(){ $('chips').innerHTML=''; addChip('Tolkat:'); }
function buildPayload(){
  return {
    beskrivning: $('beskrivning').value.trim(),
    produkt: $('konfig').value.trim(),
    adress: $('adress').value.trim(),
    namn: $('anvandare').value.trim(),
    ansvarskod: $('ansvarskod').value.trim(),
    rubrik: $('rubrik').value.trim(),
    antal: 1, pris: 0
  };
}
function applyToForm(obj){
  if(obj.namn!==undefined) $('anvandare').value = obj.namn || '';
  if(obj.adress!==undefined) $('adress').value = obj.adress || '';
  if(obj.produkt!==undefined) $('konfig').value = obj.produkt || '';
  if(obj.ansvarskod!==undefined) $('ansvarskod').value = obj.ansvarskod || '';
  if(!$('rubrik').value && obj.produkt){
    $('rubrik').value = `Beställning: ${obj.produkt}${obj.namn?` till ${obj.namn}`:''}`;
  }
  clearChips();
  if(obj.produkt) addChip(`Produkt: ${obj.produkt}`);
  if(obj.adress) addChip(`Adress: ${obj.adress}`);
  if(obj.namn) addChip(`Namn: ${obj.namn}`);
  if(obj.ansvarskod) addChip(`Ansvarskod: ${obj.ansvarskod}`);
}
function saveToStorage(extra={}){
  const base = buildPayload();
  localStorage.setItem('arendeData', JSON.stringify({...base, ...extra}));
}

/* ===========================
   1) Regelbaserad tolkning (fallback/visning)
=========================== */
function parseDescription(txt){
  const produkt = (txt.match(/iphone\s*1[5-9]|ipad|laptop|dator/i)||[])[0] || null;
  const namn = (txt.match(/([A-ZÅÄÖ][a-zåäö]+)\s+([A-ZÅÄÖ][a-zåäö]+)/)||[]).slice(0,3).join(' ') || null;
  const adr = (txt.match(/\b([A-ZÅÄÖa-zåäö]+)\s*\d+\b/)||[])[0] || null;
  const kod = (txt.match(/\bansvar(skod)?\s*:?\s*(\d{3,})/i)||[])[2] || (txt.match(/\b\d{3,}\b/)||[])[0] || null;
  return { produkt: produkt?produkt.replace(/\s+/g,' ').trim():null,
           namn: namn||null, adress: adr||null, ansvarskod: kod||null };
}

/* ===========================
   2) AI-tolkning (Azure OpenAI)
=========================== */
async function aiParse(txt){
  if(!AZURE_API_KEY || AZURE_API_KEY.includes('BYT_TILL_DIN_KEY')){
    alert('Lägg in din Azure API-nyckel i koden (AZURE_API_KEY) eller använd backend-proxy.');
    throw new Error('No API key');
  }
  const url = `${AZURE_ENDPOINT}openai/deployments/${AZURE_DEPLOYMENT}/chat/completions?api-version=${AZURE_API_VER}`;
  const prompt = `Tolkar beskrivningen nedan och returnerar ENBART giltig JSON enligt detta schema:
{
  "produkt": string|null,
  "namn": string|null,
  "adress": string|null,
  "ansvarskod": string|null,
  "antal": number|null,
  "pris": number|null
}
Beskrivning: "${txt}"`;

  const r = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'api-key': AZURE_API_KEY },
    body: JSON.stringify({
      temperature: 0.1,
      response_format: { type:'json_object' },
      messages: [
        { role:'system', content:'Du returnerar strikt JSON och inget annat.' },
        { role:'user',   content: prompt }
      ]
    })
  });
  if(!r.ok){ const t = await r.text(); throw new Error('Azure error: '+t); }
  const data = await r.json();
  const jsonStr = data?.choices?.[0]?.message?.content || '{}';
  return JSON.parse(jsonStr);
}

/* ===========================
   3) Eventkoppling
=========================== */
$('resetBtn').onclick = ()=>{
  ['anvandare','adress','konfig','ansvarskod','rubrik','beskrivning'].forEach(id=>$(id).value='');
  clearChips(); saveToStorage();
};
$('ruleBtn').onclick = ()=>{
  const p = parseDescription($('beskrivning').value.trim());
  applyToForm(p); saveToStorage(p);
};
$('aiBtn').onclick = async ()=>{
  try{
    const ai = await aiParse($('beskrivning').value.trim());
    applyToForm(ai); saveToStorage(ai);
  }catch(e){ console.error(e); alert('AI-tolkningen misslyckades. Se konsolen för detaljer.'); }
};
$('cartBtn').onclick = ()=>{
  saveToStorage();
  window.location.href = 'varukorg.html';
};

// Pre-fill demo text
$('beskrivning').value = 'iPhone 15, Gatan 2, mottagande chef Anna Larsson, ansvarskod 12345';
</script>
</body>
</html>
