<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<title>Timpool – Autofyll Mån–Fre 08–16</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f7f7f9; --card:#fff; --txt:#111827; --muted:#6b7280; --pri:#3b82f6; --ok:#16a34a; --err:#dc2626; --br:12px;
    --shadow:0 8px 24px rgba(0,0,0,.08)
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt);margin:0;padding:24px}
  h1{font-size:22px;margin:0 0 12px}
  .card{background:var(--card);border-radius:var(--br);box-shadow:var(--shadow);padding:18px;max-width:960px;margin:auto}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,button{font-size:14px}
  input[type="text"],input[type="date"],input[type="time"],select{
    padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;min-width:220px
  }
  .btn{appearance:none;border:0;background:var(--pri);color:#fff;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;color:var(--pri);border:1px solid var(--pri)}
  .btn:disabled{background:#9aa7bd;cursor:not-allowed}
  .small{font-size:12px;color:var(--muted)}
  hr{border:0;border-top:1px solid #eee;margin:14px 0}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px 8px;border-bottom:1px solid #eee;text-align:left}
  td.timecell{display:flex;gap:8px;align-items:center}
  .toast{margin-top:10px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .pill{display:inline-flex;gap:6px;align-items:center;font-size:12px;padding:4px 10px;border-radius:999px;background:#eef2ff;color:#3730a3}
</style>
</head>
<body>
  <div class="card">
    <h1>Autofyll schema – välj “Anna” → Mån–Fre 08–16</h1>

    <div class="row">
      <div>
        <label>Sök vikarie (skriv “Anna”)</label>
        <input id="searchInput" type="text" list="vikList" placeholder="Sök namn…" />
        <datalist id="vikList"></datalist>
        <div class="small" id="vikMeta"></div>
      </div>

      <div>
        <label>Period (vecka)</label>
        <div>
          <input id="startDate" type="date"> –
          <input id="endDate" type="date">
        </div>
        <div class="small">Endast vardagar (mån–fre) visas här nedan.</div>
      </div>

      <div>
        <label>Snabbval</label>
        <select id="preset">
          <option value="08:00|16:00|30">Mån–Fre 08:00–16:00 (rast 30 min)</option>
          <option value="07:00|16:00|30">Mån–Fre 07:00–16:00 (rast 30 min)</option>
          <option value="08:00|17:00|30">Mån–Fre 08:00–17:00 (rast 30 min)</option>
        </select>
      </div>

      <div>
        <button class="btn" id="btnAutofill">Fyll i schemat</button>
      </div>
    </div>

    <hr/>

    <div class="row">
      <span class="pill" id="pickedPill">Ingen vikarie vald</span>
      <span class="small" id="sumInfo"></span>
    </div>

    <table id="grid">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Dag</th>
          <th>Tider</th>
          <th>Kommentar</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="4" class="small" id="footNote">Välj vikarie och klicka “Fyll i schemat”.</td></tr>
      </tfoot>
    </table>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button class="btn" id="btnSave" disabled>Spara</button>
      <button class="btn ghost" id="btnClear">Rensa</button>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
/* -------- Mockdata -------- */
const VIKARIER = [
  { id:'v100', namn:'Anna Nilsson', kompetenser:['LSS'], maxTimPerVecka: 40, tillgänglighet:{'mån-fre':[ {start:'08:00',slut:'16:00',rastMin:30} ]}},
  { id:'v101', namn:'Anna Karlsson', kompetenser:['LSS','HSL'], maxTimPerVecka: 38, tillgänglighet:{'mån-fre':[ {start:'08:00',slut:'16:00',rastMin:30} ]}},
  { id:'v200', namn:'Bea Berg',     kompetenser:['LSS'], maxTimPerVecka: 30, tillgänglighet:{'mån-fre':[ {start:'07:00',slut:'16:00',rastMin:30} ]}},
];
let EXISTING_BOOKINGS = [
  { vikarieId:'v100', date:'2025-09-03', start:'09:00', slut:'12:00' } // krockexempel
];
const HOLIDAYS = ['2025-12-25','2025-12-26'];

/* -------- Utils -------- */
const el = id=>document.getElementById(id);
const pad = n=>n.toString().padStart(2,'0');
function iso(d){ return d.toISOString().slice(0,10); }
function parseISO(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function wdName(d){ return ['Sön','Mån','Tis','Ons','Tor','Fre','Lör'][d.getDay()]; }
function toMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
function minutesBetween(s,e){ return toMinutes(e)-toMinutes(s); }
function weekdaysBetween(startISO,endISO){
  const days=[]; let d=parseISO(startISO); const end=parseISO(endISO);
  for(; d<=end; d.setDate(d.getDate()+1)){ const k=d.getDay(); if(k>=1 && k<=5) days.push(new Date(d)); }
  return days;
}
function showToast(msg, ok=false){ const t=el('toast'); t.className='toast '+(ok?'ok':'err'); t.textContent=msg; setTimeout(()=>{t.textContent='';t.className='toast'},3500); }
function sumRowMinutes(row){ if(row.disabled) return 0; return minutesBetween(row.start,row.end)-(row.rast||0); }
async function isHoliday(dateISO){ return HOLIDAYS.includes(dateISO); }

/* -------- State -------- */
let PICKED = null;          // vald vikarie
let GRID_ROWS = [];         // [{date, day, start, end, rast, note, disabled}]
let PERIOD = {start:null, end:null};

/* -------- Init UI -------- */
function populateDatalist(){
  const dl = el('vikList'); dl.innerHTML='';
  VIKARIER.forEach(v=>{
    const opt=document.createElement('option');
    opt.value = v.namn;
    opt.label = v.namn;
    dl.appendChild(opt);
  });
}
function setDefaultWeek(){
  const now=new Date(); const day=now.getDay(); // 0 sön
  const nextMon=new Date(now); nextMon.setDate(now.getDate()+((8-day)%7||7));
  const nextFri=new Date(nextMon); nextFri.setDate(nextMon.getDate()+4);
  el('startDate').value=iso(nextMon); el('endDate').value=iso(nextFri);
  PERIOD.start=iso(nextMon); PERIOD.end=iso(nextFri);
  buildGrid();
}
function buildGrid(){
  const tb = el('grid').querySelector('tbody'); tb.innerHTML=''; GRID_ROWS=[];
  const days = weekdaysBetween(PERIOD.start, PERIOD.end);
  for(const d of days){
    const dateISO=iso(d), dayName=wdName(d);
    GRID_ROWS.push({date:dateISO, day:dayName, start:'', end:'', rast:0, note:'', disabled:false});
  }
  renderGrid();
  updateSum();
}
function renderGrid(){
  const tb = el('grid').querySelector('tbody'); tb.innerHTML='';
  for(const row of GRID_ROWS){
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${row.date}</td>
      <td>${row.day}</td>
      <td class="timecell">
        <input type="time" value="${row.start}" data-date="${row.date}" data-k="start" style="min-width:120px">
        <span>–</span>
        <input type="time" value="${row.end}" data-date="${row.date}" data-k="end" style="min-width:120px">
        <span>Rast</span>
        <input type="number" value="${row.rast}" data-date="${row.date}" data-k="rast" min="0" style="width:80px">
      </td>
      <td class="small ${row.note?.type==='err'?'err':''}">${row.note?.msg||''}</td>
    `;
    tb.appendChild(tr);
  }
  // wire inputs
  tb.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', (e)=>{
      const date = e.target.dataset.date;
      const key  = e.target.dataset.k;
      const r = GRID_ROWS.find(x=>x.date===date);
      r[key] = key==='rast' ? Number(e.target.value||0) : e.target.value;
      validateRow(r);
      renderGrid(); // re-render notes
      updateSum();
    });
  });
}
function updateSum(){
  let total=0;
  for(const r of GRID_ROWS){
    if(r.start && r.end && !r.note?.type){ total += sumRowMinutes(r); }
  }
  el('sumInfo').textContent = total ? `Summa: ${(total/60).toFixed(1)} h` : '';
  el('btnSave').disabled = !PICKED || total===0 || GRID_ROWS.every(r=>!r.start||!r.end||r.note?.type);
}

/* -------- Behaviors -------- */
function pickByName(name){
  const cand = VIKARIER.filter(v=>v.namn.toLowerCase().includes(name.toLowerCase()));
  if(!cand.length){ PICKED=null; el('pickedPill').textContent='Ingen vikarie vald'; el('vikMeta').textContent=''; updateSum(); return; }
  PICKED = cand[0]; // välj första match (t.ex. Anna)
  el('pickedPill').textContent = `Vikarie: ${PICKED.namn}`;
  el('vikMeta').textContent = `Kompetenser: ${PICKED.kompetenser.join(', ')} · Max ${PICKED.maxTimPerVecka} h/vecka`;
  updateSum();
}
function applyPresetToGrid(){
  if(!PICKED){ showToast('Välj vikarie (t.ex. skriv “Anna”) först.'); return; }
  const [s,e,r] = el('preset').value.split('|');
  for(const row of GRID_ROWS){
    row.start = s; row.end = e; row.rast = Number(r);
    validateRow(row);
  }
  renderGrid(); updateSum(); showToast('Fyllde Mån–Fre 08–16 enligt snabbval.', true);
}
function validateRow(row){
  // röd dag?
  if(HOLIDAYS.includes(row.date)){
    row.note = {type:'err', msg:'Röd dag'}; return;
  }
  // format
  if(row.start && row.end && toMinutes(row.end)<=toMinutes(row.start)){
    row.note = {type:'err', msg:'Slut ≤ start'}; return;
  }
  // överlapp (mot mockad befintlig bokning för vald vikarie)
  if(PICKED){
    const overlaps = EXISTING_BOOKINGS.some(b =>
      b.vikarieId===PICKED.id && b.date===row.date && !(row.end<=b.start || row.start>=b.slut)
    );
    if(overlaps){ row.note = {type:'err', msg:'Krock med befintlig bokning'}; return; }
  }
  row.note = null;
}

/* -------- Save (mock) -------- */
async function saveAll(){
  // samla godkända rader
  const okRows = GRID_ROWS.filter(r=>r.start && r.end && !r.note?.type);
  if(!okRows.length){ showToast('Inget att spara.'); return; }
  // enkel “transaktion”: kontrollera överlapp igen
  for(const r of okRows){
    const overlapping = EXISTING_BOOKINGS.some(b => b.vikarieId===PICKED.id && b.date===r.date && !(r.end<=b.start || r.start>=b.slut));
    if(overlapping){ showToast('Överlapp hittades vid spara. Uppdatera och försök igen.'); return; }
  }
  // skriv till mock
  EXISTING_BOOKINGS = EXISTING_BOOKINGS.concat(okRows.map(r=>({vikarieId:PICKED.id,date:r.date,start:r.start,slut:r.end})));
  showToast(`Sparade ${okRows.length} pass för ${PICKED.namn}.`, true);
}

/* -------- Events -------- */
el('searchInput').addEventListener('input', e=>pickByName(e.target.value));
el('preset').addEventListener('change', ()=>{/* inget */});
el('btnAutofill').addEventListener('click', applyPresetToGrid);
el('btnSave').addEventListener('click', saveAll);
el('btnClear').addEventListener('click', ()=>{
  GRID_ROWS.forEach(r=>{ r.start=''; r.end=''; r.rast=0; r.note=null; });
  renderGrid(); updateSum();
});
el('startDate').addEventListener('change', e=>{ PERIOD.start=e.target.value; buildGrid(); });
el('endDate').addEventListener('change', e=>{ PERIOD.end=e.target.value; buildGrid(); });

/* -------- Start -------- */
populateDatalist();
setDefaultWeek();
</script>
</body>
</html>
